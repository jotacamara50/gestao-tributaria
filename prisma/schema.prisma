generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Company {
  id                    String                  @id @default(cuid())
  cnpj                  String                  @unique
  name                  String
  tradeName             String?
  issIsento             Boolean                 @default(false)
  cnae                  String
  secondaryCnaes        String?
  regime                String                  @default("Simples Nacional")
  status                String                  @default("Ativo")
  riskLevel             String                  @default("Baixo")
  address               String?
  phone                 String?
  email                 String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  declarations          Declaration[]
  divergences           Divergence[]
  invoices              Invoice[]
  partners              Partner[]
  enquadramentoHistory  EnquadramentoHistory[]
  dteMessages           DTEMessage[]
  fiscalActions         FiscalAction[]
  fiscalHistory         FiscalHistory[]
  supportTickets        SupportTicket[]
  parcelamentos         Parcelamento[]
  guias                 Guia[]
  defis                 Defis[]
  dasdDeclarations      DasdDeclaration[]
}

model Invoice {
  id          String   @id @default(cuid())
  companyId   String
  number      String
  series      String?
  issueDate   DateTime
  value       Float
  serviceCode String?
  tomadorCnpj String?
  xmlContent  String?
  municipioPrestacao String?
  municipioTomador   String?
  issRetido          Boolean? @default(false)
  aliquotaIss        Float?
  valorIssRetido     Float?
  codigoVerificacao  String?
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, number], name: "company_number")
}

model Declaration {
  id         String   @id @default(cuid())
  companyId  String
  period     String
  type       String
  revenue    Float
  taxDue     Float
  receipt    String?
  authenticationCode String?
  regime     String?
  operationType String?
  revenueCash Float?
  revenueCompetence Float?
  xmlContent String?
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, type, period, receipt], name: "company_type_period_receipt")
}

model Repasse {
  id          String   @id @default(cuid())
  date        DateTime
  amount      Float
  origin      String
  description String?
  createdAt   DateTime @default(now())
}

model Divergence {
  id          String   @id @default(cuid())
  companyId   String
  type        String
  description String
  value       Float
  status      String   @default("Pendente")
  detectedAt  DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  resource    String
  details     String?
  ipAddress   String?
  dataBefore  String?
  dataAfter   String?
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])
}

model Settings {
  id                String   @id @default("default")
  cityName          String
  stateName         String?
  secretaryName     String?
  lawsText          String?
  logoUrl           String?
  sublimitEstadual  Float    @default(3600000)
  sublimitMunicipal Float    @default(4800000)
  address           String?
  phone             String?
  email             String?
  updatedAt         DateTime @updatedAt
}

model MunicipalLaw {
  id          String   @id @default(cuid())
  number      String
  year        Int
  description String
  fullText    String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ISSRate {
  id          String   @id @default(cuid())
  cnae        String   @unique
  description String
  rate        Float
  lawNumber   String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Partner {
  id          String    @id @default(cuid())
  companyId   String
  cpf         String
  name        String
  role        String
  startDate   DateTime
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model EnquadramentoHistory {
  id          String    @id @default(cuid())
  companyId   String
  regime      String
  isMei       Boolean   @default(false)
  startDate   DateTime
  endDate     DateTime?
  reason      String?
  createdAt   DateTime  @default(now())
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Parcelamento {
  id                 String   @id @default(cuid())
  companyId          String
  numero             String
  situacao           String
  valorTotal         Float
  quantidadeParcelas Int
  tipo               String?
  dataPedido         DateTime
  dataSituacao       DateTime?
  parcelas           Parcela[]
  company            Company  @relation(fields: [companyId], references: [id])
}

model Parcela {
  id              String   @id @default(cuid())
  parcelamentoId  String
  numero          Int
  vencimento      DateTime
  valor           Float
  situacao        String
  pagoEm          DateTime?
  valorPago       Float?
  parcelamento    Parcelamento @relation(fields: [parcelamentoId], references: [id], onDelete: Cascade)
}

model Guia {
  id             String   @id @default(cuid())
  companyId      String
  numero         String
  periodo        String
  dataEmissao    DateTime
  vencimento     DateTime
  situacao       String
  valorPrincipal Float
  valorMulta     Float
  valorJuros     Float
  valorTotal     Float
  pagoEm         DateTime?
  banco          String?
  agencia        String?
  valorPago      Float?
  tributos       GuiaTributo[]
  company        Company  @relation(fields: [companyId], references: [id])
}

model GuiaTributo {
  id             String   @id @default(cuid())
  guiaId         String
  tipo           String
  valorPrincipal Float
  valorJuros     Float
  valorMulta     Float
  guia           Guia     @relation(fields: [guiaId], references: [id], onDelete: Cascade)
}

model Defis {
  id                 String   @id @default(cuid())
  companyId          String
  exercicio          Int
  recibo             String?
  identificador      String?
  codigoAutenticacao String?
  tipo               String?
  transmitidoEm      DateTime?
  rendimentosSocios  Float?
  socios             DefisSocio[]
  company            Company  @relation(fields: [companyId], references: [id])
}

model DefisSocio {
  id        String   @id @default(cuid())
  defisId   String
  socioNome String?
  socioCpf  String?
  rendimento Float?
  participacao Float?
  defis     Defis    @relation(fields: [defisId], references: [id], onDelete: Cascade)
}

model DasdDeclaration {
  id         String   @id @default(cuid())
  companyId  String
  period     String
  deliveredAt DateTime?
  municipioIncidencia String?
  regimeEspecial      String?
  atividadeContabil   Boolean?
  receitaDeclarada    Float?
  receitaCaixa        Float?
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, period], name: "companyId_period")
}

model DTEMessage {
  id          String    @id @default(cuid())
  companyId   String
  type        String
  subject     String
  content     String
  sentAt      DateTime  @default(now())
  readAt      DateTime?
  createdBy   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [createdBy], references: [id])
}

model User {
  id          String       @id @default(cuid())
  name        String
  email       String       @unique
  password    String
  role        String       @default("AUDITOR")
  mfaEnabled  Boolean      @default(false)
  mfaSecret   String?
  cpf         String       @unique
  matricula   String?
  cargo       String?
  localTrabalho String?
  phone       String?
  profiles    String?
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  logs        AuditLog[]
  dteMessages DTEMessage[]
  fiscalActions FiscalAction[]
  fiscalHistory FiscalHistory[]
  supportTickets SupportTicket[]
}

model FiscalAction {
  id          String   @id @default(cuid())
  companyId   String
  number      String
  type        String
  subject     String
  description String?
  status      String   @default("Aberta")
  openedAt    DateTime @default(now())
  closedAt    DateTime?
  createdBy   String?

  company     Company  @relation(fields: [companyId], references: [id])
  user        User?    @relation(fields: [createdBy], references: [id])
  attachments FiscalAttachment[]
  history     FiscalHistory[]
}

model FiscalAttachment {
  id            String   @id @default(cuid())
  actionId      String
  name          String
  mimeType      String?
  size          Int?
  contentBase64 String?
  createdAt     DateTime @default(now())

  action        FiscalAction @relation(fields: [actionId], references: [id], onDelete: Cascade)
}

model FiscalHistory {
  id        String   @id @default(cuid())
  actionId  String?
  companyId String
  type      String
  note      String
  createdAt DateTime @default(now())
  createdBy String?

  company   Company       @relation(fields: [companyId], references: [id])
  action    FiscalAction? @relation(fields: [actionId], references: [id])
  user      User?         @relation(fields: [createdBy], references: [id])
}

model SupportTicket {
  id             String   @id @default(cuid())
  protocol       String   @unique
  subject        String
  category       String   // Parada total, Comprometido, Duvidas/Relatorios
  priority       String   // Alta, Media, Baixa
  description    String
  requester      String
  status         String   @default("Aberto")
  slaHours       Int
  openedAt       DateTime @default(now())
  closedAt       DateTime?
  attachmentName String?
  companyId      String?
  createdBy      String?

  company        Company? @relation(fields: [companyId], references: [id])
  user           User?    @relation(fields: [createdBy], references: [id])
}

model ImportLog {
  id        String   @id @default(cuid())
  type      String
  fileName  String?
  fileSize  Int?
  status    String   // success | partial | error
  message   String?
  errors    String?
  createdAt DateTime @default(now())
}
