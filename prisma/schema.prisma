generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Company {
  id                    String                  @id @default(cuid())
  cnpj                  String                  @unique
  name                  String
  tradeName             String?
  cnae                  String
  secondaryCnaes        String?
  regime                String                  @default("Simples Nacional")
  status                String                  @default("Ativo")
  riskLevel             String                  @default("Baixo")
  address               String?
  phone                 String?
  email                 String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  declarations          Declaration[]
  divergences           Divergence[]
  invoices              Invoice[]
  partners              Partner[]
  enquadramentoHistory  EnquadramentoHistory[]
  dteMessages           DTEMessage[]
  fiscalActions         FiscalAction[]
  fiscalHistory         FiscalHistory[]
}

model Invoice {
  id          String   @id @default(cuid())
  companyId   String
  number      String
  series      String?
  issueDate   DateTime
  value       Float
  serviceCode String?
  tomadorCnpj String?
  xmlContent  String?
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id])
}

model Declaration {
  id         String   @id @default(cuid())
  companyId  String
  period     String
  type       String
  revenue    Float
  taxDue     Float
  xmlContent String?
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id])
}

model Repasse {
  id          String   @id @default(cuid())
  date        DateTime
  amount      Float
  origin      String
  description String?
  createdAt   DateTime @default(now())
}

model Divergence {
  id          String   @id @default(cuid())
  companyId   String
  type        String
  description String
  value       Float
  status      String   @default("Pendente")
  detectedAt  DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  resource    String
  details     String?
  ipAddress   String?
  dataBefore  String?
  dataAfter   String?
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])
}

model Settings {
  id                String   @id @default("default")
  cityName          String
  stateName         String?
  secretaryName     String?
  lawsText          String?
  logoUrl           String?
  sublimitEstadual  Float    @default(3600000)
  sublimitMunicipal Float    @default(4800000)
  address           String?
  phone             String?
  email             String?
  updatedAt         DateTime @updatedAt
}

model MunicipalLaw {
  id          String   @id @default(cuid())
  number      String
  year        Int
  description String
  fullText    String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ISSRate {
  id          String   @id @default(cuid())
  cnae        String   @unique
  description String
  rate        Float
  lawNumber   String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Partner {
  id          String    @id @default(cuid())
  companyId   String
  cpf         String
  name        String
  role        String
  startDate   DateTime
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model EnquadramentoHistory {
  id          String    @id @default(cuid())
  companyId   String
  regime      String
  startDate   DateTime
  endDate     DateTime?
  reason      String?
  createdAt   DateTime  @default(now())
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model DTEMessage {
  id          String    @id @default(cuid())
  companyId   String
  type        String
  subject     String
  content     String
  sentAt      DateTime  @default(now())
  readAt      DateTime?
  createdBy   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [createdBy], references: [id])
}

model User {
  id          String       @id @default(cuid())
  name        String
  email       String       @unique
  password    String
  role        String       @default("AUDITOR")
  mfaEnabled  Boolean      @default(false)
  mfaSecret   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  logs        AuditLog[]
  dteMessages DTEMessage[]
  fiscalActions FiscalAction[]
  fiscalHistory FiscalHistory[]
}

model FiscalAction {
  id          String   @id @default(cuid())
  companyId   String
  number      String
  type        String
  subject     String
  description String?
  status      String   @default("Aberta")
  openedAt    DateTime @default(now())
  closedAt    DateTime?
  createdBy   String?

  company     Company  @relation(fields: [companyId], references: [id])
  user        User?    @relation(fields: [createdBy], references: [id])
  attachments FiscalAttachment[]
  history     FiscalHistory[]
}

model FiscalAttachment {
  id            String   @id @default(cuid())
  actionId      String
  name          String
  mimeType      String?
  size          Int?
  contentBase64 String?
  createdAt     DateTime @default(now())

  action        FiscalAction @relation(fields: [actionId], references: [id], onDelete: Cascade)
}

model FiscalHistory {
  id        String   @id @default(cuid())
  actionId  String?
  companyId String
  type      String
  note      String
  createdAt DateTime @default(now())
  createdBy String?

  company   Company       @relation(fields: [companyId], references: [id])
  action    FiscalAction? @relation(fields: [actionId], references: [id])
  user      User?         @relation(fields: [createdBy], references: [id])
}
